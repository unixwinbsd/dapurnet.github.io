<!DOCTYPE html>
<html lang="en"><head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible"
            content="IE=edge">
      <meta name="viewport"
            content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/icon/apple-touch-icon.png" />
<link rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/icon/favicon-32x32.png" />
<link rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/icon/favicon-16x16.png" />
<link rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/icon/favicon-96x96.png" />
<link rel="manifest"
      href="/assets/icon/site.webmanifest" />
<meta name="msapplication-TileColor"
      content="#00a300" />
<meta name="theme-color"
      content="#ffffff" />
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Building a Console App with .NET Generic Host | UnixBSDShell</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Building a Console App with .NET Generic Host" />
<meta name="author" content="Iwan Setiawan" />
<meta property="og:locale" content="en" />
<meta name="description" content="The .NET Generic Host is a feature which sets up some convenient patterns for an application including those for dependency injection (DI), logging, and configuration. It was originally named Web Host and intended for Web scenarios like ASP.NET Core applications but has since been generalized (hence the rename to Generic Host) to support other scenarios, such as Windows services, Linux daemon services, or even a console app." />
<meta property="og:description" content="The .NET Generic Host is a feature which sets up some convenient patterns for an application including those for dependency injection (DI), logging, and configuration. It was originally named Web Host and intended for Web scenarios like ASP.NET Core applications but has since been generalized (hence the rename to Generic Host) to support other scenarios, such as Windows services, Linux daemon services, or even a console app." />
<link rel="canonical" href="http://192.168.5.71:4000/.net/2020/08/24/building-a-console-app-with-.net-generic-host/" />
<meta property="og:url" content="http://192.168.5.71:4000/.net/2020/08/24/building-a-console-app-with-.net-generic-host/" />
<meta property="og:site_name" content="UnixBSDShell" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-24T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Building a Console App with .NET Generic Host" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Iwan Setiawan"},"dateModified":"2020-08-24T00:00:00+07:00","datePublished":"2020-08-24T00:00:00+07:00","description":"The .NET Generic Host is a feature which sets up some convenient patterns for an application including those for dependency injection (DI), logging, and configuration. It was originally named Web Host and intended for Web scenarios like ASP.NET Core applications but has since been generalized (hence the rename to Generic Host) to support other scenarios, such as Windows services, Linux daemon services, or even a console app.","headline":"Building a Console App with .NET Generic Host","mainEntityOfPage":{"@type":"WebPage","@id":"http://192.168.5.71:4000/.net/2020/08/24/building-a-console-app-with-.net-generic-host/"},"url":"http://192.168.5.71:4000/.net/2020/08/24/building-a-console-app-with-.net-generic-host/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet"
            href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://192.168.5.71:4000/feed.xml" title="UnixBSDShell" /></head><body><header class="site-header">

    <div class="wrapper">
        <a class="site-title"
           rel="author"
           href="/">UnixBSDShell</a>

        <nav class="site-nav">
            <input type="checkbox"
                   id="nav-trigger"
                   class="nav-trigger" />
            <label for="nav-trigger">
                <span class="menu-icon">
                    <svg viewBox="0 0 18 15"
                         width="18px"
                         height="15px">
                        <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
                    </svg>
                </span>
            </label>

            <div class="trigger"><a class="page-link"
                   href="/categories/">Categories</a><a class="page-link"
                   href="/about/">About</a></div>
        </nav>

        <a href="/"
           class="site-banner">
            <img src="/assets/banner.png"
                 alt="David's Blog">
        </a>

        <div class="social-links"><ul class="social-media-list">
    <li>
        <a rel="me"
           href="https://github.com/dfederm"
           title="dfederm">
            <svg class="svg-icon">
                <use xlink:href="/assets/social-icons.svg#github"></use>
            </svg>
        </a>
    </li>
    <li>
        <a href="/feed.xml"
           title="Subscribe">
            <svg class="svg-icon">
                <use xlink:href="/assets/social-icons.svg#rss"></use>
            </svg>
        </a>
    </li>
</ul></div>
    </div>
</header><main class="page-content"
          aria-label="Content">
        <div class="wrapper">
            <div class="post-nav"><span class="post-previous">
        <a href="/home%20automation/self%20hosting/2020/04/25/setting-up-a-security-system-with-home-assistant/"
           rel="prev">← Previous Post</a>
    </span><span class="post-next">
        <a href="/.net/msbuild/2020/12/13/debugging-msbuild/"
           rel="next">Next Post →</a>
    </span></div>

<article class="post h-entry"
         itemscope
         itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name"
            itemprop="name headline">Building a Console App with .NET Generic Host</h1>
        <p class="post-meta">
            <time class="dt-published"
                  datetime="2020-08-24T00:00:00+07:00"
                  itemprop="datePublished">
                Aug 24, 2020
            </time>• Posted in
            
            <a href="/categories/#.net">.NET</a></p>
    </header>

    <div class="post-content e-content"
         itemprop="articleBody">
        <p>The <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host" target="_blank">.NET Generic Host</a> is a feature which sets up some convenient patterns for an application including those for <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" target="_blank">dependency injection (DI)</a>, <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging" target="_blank">logging</a>, and <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration" target="_blank">configuration</a>. It was originally named Web Host and intended for Web scenarios like ASP.NET Core applications but has since been generalized (hence the rename to <em>Generic</em> Host) to support other scenarios, such as Windows services, Linux daemon services, or even a console app.</p>

<p>A working example can be found at <a href="https://github.com/dfederm/GenericHostConsoleApp" target="_blank">dfederm/GenericHostConsoleApp</a>.</p>

<h2 id="basics">Basics</h2>

<p>You will first need to create a new console application and add a <code class="language-plaintext highlighter-rouge">PackageReference</code> to <a href="https://www.nuget.org/packages/Microsoft.Extensions.Hosting/" target="_blank"><code class="language-plaintext highlighter-rouge">Microsoft.Extensions.Hosting</code></a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new console
dotnet add package Microsoft.Extensions.Hosting
</code></pre></div></div>

<p>Now for the <code class="language-plaintext highlighter-rouge">Main</code> method. Typically the <code class="language-plaintext highlighter-rouge">Main</code> method for console apps just immediately jump into the application’s core logic, but when using the .NET Generic Host, instead the host is set up. This should look familiar if you’ve developed web applications using the Web Host or Generic Host before.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">Host</span><span class="p">.</span><span class="nf">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">RunConsoleAsync</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Running that alone will start up the host, but without any logic it will do nothing and never exit. The generic host simply sets up some reasonable <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host#default-builder-settings" target="_blank">defaults</a> around configuration and logging, as well as provides a few services in the DI container which handle the the application lifetime. Calling <code class="language-plaintext highlighter-rouge">RunConsoleAsync</code> will run start the host and wait for a <code class="language-plaintext highlighter-rouge">Ctrl+C</code> or <code class="language-plaintext highlighter-rouge">SIGTERM</code> to exit, which means without explicitly telling the app to exit, it will not exit.</p>

<p>To actually implement your console app’s logic, and get the application to exit after it’s done, you’ll want to implement and register an <code class="language-plaintext highlighter-rouge">IHostedService</code>, as well as interact with the <code class="language-plaintext highlighter-rouge">IHostApplicationLifetime</code> from the DI container.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">Host</span><span class="p">.</span><span class="nf">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">ConfigureServices</span><span class="p">((</span><span class="n">hostContext</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">ConsoleHostedService</span><span class="p">&gt;();</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nf">RunConsoleAsync</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ConsoleHostedService</span> <span class="p">:</span> <span class="n">IHostedService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHostApplicationLifetime</span> <span class="n">_appLifetime</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ConsoleHostedService</span><span class="p">(</span>
        <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ConsoleHostedService</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">,</span>
        <span class="n">IHostApplicationLifetime</span> <span class="n">appLifetime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="n">_appLifetime</span> <span class="p">=</span> <span class="n">appLifetime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">$"Starting with arguments: </span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetCommandLineArgs</span><span class="p">())}</span><span class="s">"</span><span class="p">);</span>

        <span class="n">_appLifetime</span><span class="p">.</span><span class="n">ApplicationStarted</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">);</span>

                    <span class="c1">// Simulate real work is being done</span>
                    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Unhandled exception!"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">finally</span>
                <span class="p">{</span>
                    <span class="c1">// Stop the application once the work is done</span>
                    <span class="n">_appLifetime</span><span class="p">.</span><span class="nf">StopApplication</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Other useful events to subscribe to on the <code class="language-plaintext highlighter-rouge">IHostApplicationLifetime</code> are <code class="language-plaintext highlighter-rouge">ApplicationStopping</code> and <code class="language-plaintext highlighter-rouge">ApplicationStopped</code>.</p>

<p>Note that you can registrer multiple <code class="language-plaintext highlighter-rouge">IHostedService</code> implementations and each of them will have their <code class="language-plaintext highlighter-rouge">StartAsync</code> and <code class="language-plaintext highlighter-rouge">StopAsync</code> methods called. However, personally I find that to be a bit confusing for a console application, so I would just stick to a single <code class="language-plaintext highlighter-rouge">IHostedService</code>.</p>

<h2 id="dependency-injection">Dependency Injection</h2>

<p>As you may have noticed, your <code class="language-plaintext highlighter-rouge">IHostedService</code> implementation has full access to the DI container, so you can register services in <code class="language-plaintext highlighter-rouge">Main</code> and then use them in your <code class="language-plaintext highlighter-rouge">IHostedService</code>.</p>

<p>In <code class="language-plaintext highlighter-rouge">Main</code>:</p>
<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">Host</span><span class="p">.</span><span class="nf">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">ConfigureServices</span><span class="p">((</span><span class="n">hostContext</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">ConsoleHostedService</span><span class="p">&gt;();</span>
            <span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IWeatherService</span><span class="p">,</span> <span class="n">WeatherService</span><span class="p">&gt;();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">RunConsoleAsync</span><span class="p">();</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">ConsoleHostedService</code></p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IHostApplicationLifetime</span> <span class="n">_appLifetime</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IWeatherService</span> <span class="n">_weatherService</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">ConsoleHostedService</span><span class="p">(</span>
    <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ConsoleHostedService</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">,</span>
    <span class="n">IHostApplicationLifetime</span> <span class="n">appLifetime</span><span class="p">,</span>
    <span class="n">IWeatherService</span> <span class="n">weatherService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="n">_appLifetime</span> <span class="p">=</span> <span class="n">appLifetime</span><span class="p">;</span>
    <span class="n">_weatherService</span> <span class="p">=</span> <span class="n">weatherService</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_appLifetime</span><span class="p">.</span><span class="n">ApplicationStarted</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">temperatures</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_weatherService</span><span class="p">.</span><span class="nf">GetFiveDayTemperaturesAsync</span><span class="p">();</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">temperatures</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Today</span><span class="p">.</span><span class="nf">AddDays</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">DayOfWeek</span><span class="p">}</span><span class="s">: </span><span class="p">{</span><span class="n">temperatures</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Unhandled exception!"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span>
                <span class="c1">// Stop the application once the work is done</span>
                <span class="n">_appLifetime</span><span class="p">.</span><span class="nf">StopApplication</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="exit-code">Exit Code</h2>
<p>To return a non-zero exit code, your <code class="language-plaintext highlighter-rouge">IHostedService</code> implementation can set <code class="language-plaintext highlighter-rouge">Environment.ExitCode</code> when the host is stopping.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ConsoleHostedService</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">int</span><span class="p">?</span> <span class="n">_exitCode</span><span class="p">;</span>

        <span class="c1">// ...</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// ...</span>

            <span class="n">_appLifetime</span><span class="p">.</span><span class="n">ApplicationStarted</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="c1">// ...</span>

                        <span class="n">_exitCode</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Unhandled exception!"</span><span class="p">);</span>
                        <span class="n">_exitCode</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">finally</span>
                    <span class="p">{</span>
                        <span class="c1">// Stop the application once the work is done</span>
                        <span class="n">_appLifetime</span><span class="p">.</span><span class="nf">StopApplication</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">$"Exiting with return code: </span><span class="p">{</span><span class="n">_exitCode</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

            <span class="c1">// Exit code may be null if the user cancelled via Ctrl+C/SIGTERM</span>
            <span class="n">Environment</span><span class="p">.</span><span class="n">ExitCode</span> <span class="p">=</span> <span class="n">_exitCode</span><span class="p">.</span><span class="nf">GetValueOrDefault</span><span class="p">(-</span><span class="m">1</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="logging-and-configuration">Logging and Configuration</h2>
<p>Logging and configuration work mostly just as they do in Web applications. The one caveat is that because <code class="language-plaintext highlighter-rouge">appsettings.json</code> is loaded from the content root, which for the Generic Host is the current working directory by default, the content root needs to be set to the same directly the executable is in using <code class="language-plaintext highlighter-rouge">UseContentRoot</code>.</p>

<p>In <code class="language-plaintext highlighter-rouge">Main</code>:</p>
<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">Host</span><span class="p">.</span><span class="nf">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">UseContentRoot</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetDirectoryName</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">ConfigureLogging</span><span class="p">(</span><span class="n">logging</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Add any 3rd party loggers like NLog or Serilog</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">ConfigureServices</span><span class="p">((</span><span class="n">hostContext</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">services</span>
            <span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">ConsoleHostedService</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IWeatherService</span><span class="p">,</span> <span class="n">WeatherService</span><span class="p">&gt;();</span>

        <span class="n">services</span><span class="p">.</span><span class="n">AddOptions</span><span class="p">&lt;</span><span class="n">WeatherSettings</span><span class="p">&gt;().</span><span class="nf">Bind</span><span class="p">(</span><span class="n">hostContext</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetSection</span><span class="p">(</span><span class="s">"Weather"</span><span class="p">));</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">RunConsoleAsync</span><span class="p">();</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">WeatherService.cs</code>:</p>
<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">WeatherService</span> <span class="p">:</span> <span class="n">IWeatherService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IOptions</span><span class="p">&lt;</span><span class="n">WeatherSettings</span><span class="p">&gt;</span> <span class="n">_weatherSettings</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">WeatherService</span><span class="p">(</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">WeatherSettings</span><span class="p">&gt;</span> <span class="n">weatherSettings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_weatherSettings</span> <span class="p">=</span> <span class="n">weatherSettings</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="nf">GetFiveDayTemperaturesAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">int</span><span class="p">[]</span> <span class="n">temperatures</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="m">76</span><span class="p">,</span> <span class="m">76</span><span class="p">,</span> <span class="m">77</span><span class="p">,</span> <span class="m">79</span><span class="p">,</span> <span class="m">78</span> <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_weatherSettings</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Unit</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"C"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">temperatures</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">temperatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Round</span><span class="p">((</span><span class="n">temperatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">-</span> <span class="m">32</span><span class="p">)</span> <span class="p">/</span> <span class="m">1.8</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">temperatures</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">WeatherSettings.cs</code>:</p>
<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">WeatherSettings</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Unit</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the project file:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Content</span> <span class="na">Include=</span><span class="s">"appsettings.json"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;CopyToOutputDirectory&gt;</span>PreserveNewest<span class="nt">&lt;/CopyToOutputDirectory&gt;</span>
    <span class="nt">&lt;/Content&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">appsettings.json</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
            </span><span class="err">//</span><span class="w"> </span><span class="err">Avoid</span><span class="w"> </span><span class="err">logging</span><span class="w"> </span><span class="err">lifetime</span><span class="w"> </span><span class="err">events</span><span class="w">
            </span><span class="nl">"Microsoft.Hosting.Lifetime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"Weather"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Unit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
</div><a class="u-url"
       href="/.net/2020/08/24/building-a-console-app-with-.net-generic-host/"
       hidden></a>
</article>
        </div>
    </main><footer class="site-footer h-card">
    <data class="u-url"
          href="/"></data>

    <div class="wrapper">

        <div class="footer-col-wrapper">
            <div class="footer-col">
                <h2 class="footer-heading">UnixBSDShell</h2>
                <p>A Blog That Focuses On UNIX Systems, Such As FreeBSD OpenBSD NetBSD and Others</p>
            </div>
            <div class="footer-col">
                <p>&copy; Copyright unixwinbsd</p>
                <p>
                    <a href="/privacy-policy/">Privacy Policy</a>
                    &bull;
                    <a href="/license/">License</a>
                </p>
            </div>
        </div>

        <div class="social-links"><ul class="social-media-list">
    <li>
        <a rel="me"
           href="https://github.com/dfederm"
           title="dfederm">
            <svg class="svg-icon">
                <use xlink:href="/assets/social-icons.svg#github"></use>
            </svg>
        </a>
    </li>
    <li>
        <a href="/feed.xml"
           title="Subscribe">
            <svg class="svg-icon">
                <use xlink:href="/assets/social-icons.svg#rss"></use>
            </svg>
        </a>
    </li>
</ul></div>

    </div>

</footer>
</body>

</html>